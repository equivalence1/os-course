\begin{frame}
\frametitle{Репликация данных}
\begin{itemize}
  \item<1-> В распределенной ФС данные реплицируются:
    \begin{itemize}
      \item если есть несколько копий данных, то читать можно из любой - больше скорость чтения;
      \item не страшно потерять копию данных;
    \end{itemize}
  \item<2-> Возникает проблема совместного обновления всех этих копий:
    \begin{itemize}
      \item если сервера не ломаются и сообщения не теряются - то проблемы нет;
      \item но сервера могут выходить из строя и возвращаться в строй;
      \item обновления могут приходить параллельно от нескольких клиентов - нужна сериализация;
    \end{itemize}
\end{itemize}
\end{frame}

\begin{frame}
\frametitle{Консенсус}
\begin{itemize}
  \item<1-> Консенсус - теоретическая модель, к которой сводится целый класс задач:
    \begin{itemize}
      \item репликация;
      \item выбор лидера;
      \item атомарный broadcast;
    \end{itemize}
  \item<2-> Задача достижения консенсуса (неформально):
    \begin{itemize}
      \item имеется $N$ участников (агентов, процессоров, узлов);
      \item участники предлагают некоторые значения $v_i$;
      \item участники должны договорится и выбрать одно из предложенных $v_i$;
    \end{itemize}
\end{itemize}
\end{frame}

\begin{frame}
\frametitle{Консенсус}
\begin{itemize}
  \item<1-> Более формальная постановка задачи:
    \begin{itemize}
      \item имеется $N$ процессов;
      \item каждый процесс описывается 3 значениями: $v_i$, $d_i$ и $c_i$;
      \item $v_i$ - значение предложенное процессом $i$;
      \item $d_i$ - значение выбранное процессом $i$;
      \item $c_i = True$, если процесс $i$ выбрал значение, и $c_i = False$ в противном случае (изменяется только один раз);
    \end{itemize}
  \item<2-> требуется придумать способ выбора значения такой чтобы выполнялись свойства:
    \begin{itemize}
      \item согласованность: $\forall i,j : c_i \land c_j \implies d_i = d_j$;
      \item валидность: $\left(\forall i : v_i = k\right) \implies \left(\forall i : c_i \implies d_i = k\right)$;
      \item завершаемость: все корректные процессы выберут значение за конечное число шагов, т. е. $c_i = True$;
    \end{itemize}
\end{itemize}
\end{frame}

\begin{frame}
\frametitle{Ошибки передачи сообщений}
\begin{itemize}
  \item<1-> Процессы могут обмениваться сообщениями произвольного вида
    \begin{itemize}
      \item мы можем рассматривать решение задачи о консенсусе в различных ограничениях;
      \item например, мы можем предполагать, что сообщения могут теряться;
    \end{itemize}
  \item<2-> Допустим сообщения теряются:
    \begin{itemize}
      \item теряются именно сообщения, а не процессы падают и не могут их получить;
      \item как можно решить задачу о консенсусе при потере сообщений?
    \end{itemize}
\end{itemize}
\end{frame}

\begin{frame}
\frametitle{Проблема двух генералов}
\begin{itemize}
  \item<1-> Два генерала руководят двумя армиями и хотят совместно вторгнуться в город
    \begin{itemize}
      \item армии должны напасть на город одновременно, т. е. нужно договориться о времени атаки;
      \item генералы не могут видеть что делает другая армия, но могут обмениться сообщениями;
      \item гонец сообщениями проходит мимо города и его могут подстрелить;
    \end{itemize}
  \item<2-> Один из генералов (самый высокий, или самый толстый или просто самый главный) предлагает время
    \begin{itemize}
      \item он отправляет сообщение с гонцом к другому генералу;
      \item может ли армия атаковать город в предложенное время?
    \end{itemize}
\end{itemize}
\end{frame}

\begin{frame}
\frametitle{Проблема двух генералов}
\begin{itemize}
  \item<1-> Атаковать в предложенное время не безопасно:
    \begin{itemize}
      \item мы не знаем получил ли второй генерал сообщение;
      \item нужно подождать подтверждения;
    \end{itemize}
  \item<2-> Второй генерал получает сообщение и соглашается на указанное время
    \begin{itemize}
      \item он отправляет ответное сообщение с подтверждением;
      \item может ли армия теперь атаковать город в указанное время?
    \end{itemize}
\end{itemize}
\end{frame}

\begin{frame}
\frametitle{Проблема двух генералов}
\begin{itemize}
  \item<1-> Атаковать в указанное время опять не безопасно:
    \begin{itemize}
      \item мы не знаем получил ли первый генерал наше подтверждение;
      \item если он его не получил, то он может думать, что сообщение не доставлено;
      \item нужно ждать подтверждения на подтверждение;
    \end{itemize}
  \item<2-> Первый генерал получает подтверждение
    \begin{itemize}
      \item он отправляет ответное сообщение с подтверждением на подтверждение;
      \item может ли армия теперь атаковать город в выбранное время?
    \end{itemize}
\end{itemize}
\end{frame}

\begin{frame}
\frametitle{Проблема двух генералов}
\begin{itemize}
  \item<1-> Атаковать в указанное время опять не безопасно:
    \begin{itemize}
      \item мы не знаем получил ли второй генерал наше подтверждение на подтверждение;
      \item если он его не получил, то он может думать, что подтверждение не доставлено;
    \end{itemize}
  \item<2-> Детерминированный алгоритм для достижения консенсуса при потерях не существует:
    \begin{itemize}
      \item допустим противное и такой алгоритм существует и он завершается за $k$ сообщений;
      \item алгоритм должен переживать потери сообщений, а значит он может потерять $k$-ое сообщение;
      \item т. е. тот же алгоритм должен завершится и за $k-1$ сообщение;
    \end{itemize}
\end{itemize}
\end{frame}

\begin{frame}
\frametitle{Синхронность и асинхронность}
\begin{itemize}
  \item<1-> Пусть соединение теперь надежное
    \begin{itemize}
      \item обычно мы полагаемся на TCP;
      \item TCP не дает гарантий, но на практике ломается в очень суровых ситуациях;
    \end{itemize}
  \item<2-> Можем ли мы решить задачу о консенсусе? Зависит от условий:
    \begin{itemize}
      \item могут ли процессоры "падать" или нет?
      \item существуют ли ограничения на время доставки и обработки сообщения или нет?
    \end{itemize}
  \item<3-> Синхронные и асинхронные системы:
    \begin{itemize}
      \item система синхронна, если известны ограничения на время доставки и обработки сообщения;
      \item система асинхронна, если ограничений нет (мы не можем узнать "упал" процессор или просто долго думает);
    \end{itemize}
\end{itemize}
\end{frame}

\begin{frame}
\frametitle{Консенсус в асинхронных системах}
\begin{itemize}
  \item<1-> Если сообщения не теряются и процессоры не "падают", то консенсус легко достижим
    \begin{itemize}
      \item мы только не знаем, сколько времени нам на это понадобится;
    \end{itemize}
  \item<2-> Что если процессоры "падают"?
    \begin{itemize}
      \item если процессор после "падения" не восстанавливается, то детерминированного алгоритма достижения консенсуса не существует;
      \item причем достаточно ровно одного падения в правильном месте;
      \item этот факт известен как "FLP Impossibility";
    \end{itemize}
  \item<3-> Что делать если консенсус все-таки нужен?
    \begin{itemize}
      \item многие системы являются именно асинхронными (чем больше промежуточных узлов тем хуже);
      \item считаем, что все узлы возвращаются после падения;
    \end{itemize}
\end{itemize}
\end{frame}
